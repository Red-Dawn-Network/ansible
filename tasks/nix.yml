---
- name: Check if Nix has been installed
  ansible.builtin.stat:
    path: /nix
  register: nix_result

- name: Install Nix
  when: not nix_result.stat.exists
  block:
    - name: Download Determinate Nix installer
      ansible.builtin.uri:
        url: https://install.determinate.systems/nix
        dest: /tmp/nix-installer.sh
        mode: "0755"

    - name: Run Determinate Nix installer
      ansible.builtin.command: /tmp/nix-installer.sh install --determinate --no-confirm
      register: nix_install
      changed_when: nix_install.rc == 0

    - name: Cleanup Determinate Nix installer
      ansible.builtin.file:
        path: /tmp/nix-installer.sh
        state: absent

- name: Check if running in test container
  ansible.builtin.stat:
    path: /etc/skel/armarserver
  register: container_result

- name: Configure flakes for heywoodlh
  when: not container_result.stat.exists  # Skip if running in container to reduce runtime
  block:
    - name: Loop over flakes
      ansible.builtin.shell: "/nix/var/nix/profiles/default/bin/nix profile add {{ item }} --override-input nixpkgs github:nixos/nixpkgs/nixpkgs-unstable || true"
      become: true
      become_user: heywoodlh
      register: flake_install
      changed_when: flake_install.rc == 0
      loop:
        - "github:heywoodlh/flakes?dir=fish#tmux"
        - "github:heywoodlh/flakes#vim"
        - "github:heywoodlh/flakes#git"

    - name: Check if tmux flake has been installed
      ansible.builtin.stat:
        path: /home/heywoodlh/.nix-profile/bin/tmux
      register: tmux_result

    - name: Remove old tmux invocation
      ansible.builtin.lineinfile:
        path: /home/heywoodlh/.bashrc
        line: '[ -z "${TMUX}" ] && { "${HOME}"/.nix-profile/bin/tmux new-session -A -s main && exit;}'
        state: absent

    - name: Configure heywoodlh to use tmux on login
      ansible.builtin.blockinfile:
        path: /home/heywoodlh/.bashrc
        block: |
          if [[ -e ${HOME}/.nix-profile/bin/tmux ]]
          then
              [ -z "${TMUX}" ] && { "${HOME}"/.nix-profile/bin/tmux new-session -A -s main && exit;}
          fi
      when: tmux_result.stat.exists
